<html>
  <head>
    <script src="./js/lib/jquery.min.js"></script>
    <script src="./js/lib/jquery.transit.min.js"></script>
    <script src="./js/lib/jquery.csv.min.js"></script>
    <script src="./js/lib/jquery.ba-throttle-debounce.min.js"></script>
    <title>The Price of Humanity</title>
    <link rel="stylesheet" href="css/reset.css" type="text/css">
    <style type="text/css">
       body{
        color:#fff;
        font-family:helvetica,sans-serif;
       }
       a{
        color:#fff;
        text-decoration:none;
       }
       ul, li{
            margin:0;
           padding;0;
           list-style-type:none;
       }
       #interface{
        height:100%;
        width:100%;
        position:fixed;
       }
       #header{
        height:40px;
        width:100%;
        position:absolute;
        background:#000;
        text-align:center;
        text-transform:uppercase;
       }
       #header h1{
        height:40px;
        line-height:40px;
        float:left;
        font-weight:bold;
        margin:0 0 0 10px;
       }
       .overlay{
        position:absolute;
        top:0;
        left:0;
        height:100%;
        width:100%;
        bottom:0;
        right:0;
        background:rgba(0,0,0,0.75);
        text-align:center;
       }
       .message{
        position:absolute;
        top:50%;
        height:10em;
        margin:-6em auto 0 auto;
        background:#000;
        padding:1em;
       }
       .button{
        color:#000;
        background:#fff;
        padding:4px 8px;
        font-size:1.5em;
       }
       #cost{
        width:100px;
        position:absolute;
        top:40px;
        bottom:0px;
        left:0px;
        background:#000;
       }
       #location{
        width:150px;
        position:absolute;
        right:0px;
        top:40px;
        bottom:0px;
        background:#000;
       }
       #cost li{
        text-indent:-9999;
        display:block;
        height:1px;
        width:100%;
        background:#fff;
        margin:1px 0;
        opacity:0.5;
       }
       #location li{
        margin:1px 0;
        font-size:12px;
        background:#fff;
        opacity:0.5;
        text-align:left;
        padding:0px 4px 0px 10px;
        height:17px;
        line-height:17px;
        display:block;
       }
       #location li a{
        color:#000;
       }
       #content{
        height:100%;
        width:100%;
        position:absolute;
        bottom:0;
        right:0;
        left:0;
        top:0;
       }
       #content li{
        display:block;
        width:100%;
        height:100%;
        overflow:hidden;
        position:relative;
       }
       #content img, #content canvas{
        position:absolute;
        top:0;
        filter: saturate(30%) contrast(85%);
        -webkit-filter: saturate(30%) contrast(85%);
        -moz-filter: saturate(30%) contrast(85%);
        -o-filter: saturate(30%) contrast(85%);
        -ms-filter: saturate(30%) contrast(85%);
        min-height:100%;
        height:auto;
        width:60%;
       }
       #content img{
        left:0;
       }
       #content canvas{
        right:0;
       }
       #content .info{
        display:block;
        position:absolute;
        bottom:40px;
        left:0;
        text-align:center;
        width:100%;
       }
       #content h2, #content h3{
        background:#000;
        padding:5px 10px;
        margin:0 0 15px 0;
        display:inline-block;
        font-weight:bold;
        max-width:80%;
        }
        #content h2{
            font-size:3em;
        }
        #content h3{
            font-size:1.5em;
        }
    </style>
  </head>
  <body>
  <div id="fb-root"></div>
    <script>    
window.fbAsyncInit = function() {
    //FB is ready
    FB.init({
      appId      : '428729383937921',
      status     : true,
      xfbml      : true
    });

$( document ).ready(function() {
    //FB and jQuery are ready
    
    var friends = [];
    var costs;
    var costImages;
    var dataLoaded = false;
    var friendsLoaded = false;
    var $window = $(window);
    var MENU_TIMEOUT = 2000;
    var MENU_ANIM_TIME = 1000;
    var minCost;
    var maxCost;
    
    var menuTimeout = setTimeout(hideMenu,MENU_TIMEOUT);
    
    $(window).scroll(showMenu);
    $(window).scroll($.debounce(500,snapToContent));
    
    $(window).resize(function() {
        snapToContent();
        if(dataLoaded){
          $('#cost li').each(function(i,$c){
            var value =  parseInt($c.attr('data-value'));
            $c.css({
              top:(Math.round((value-minCost)/(maxCost-minCost)*$(window).height()))+'px';
            });
          });
        }
    });
    
    function snapToContent(){
      var h = $window.height();
        $("html, body").animate({ scrollTop: (Math.round($window.scrollTop()/h)*h)+"px" });
    }
    
    var animatingMenu = false;
    var menuAnimTimeout;
    function hideMenu(){
        clearTimeout(menuAnimTimeout);
        if(!animatingMenu){
            animatingMenu = true;
            $('#location').transition({
                right:-$('#location').width(),
                duration: MENU_ANIM_TIME
            });
            $('#cost').transition({
                left:-$('#cost').width(),
                duration: MENU_ANIM_TIME
            });
        }
        menuAnimTimeout = setTimeout(function(){animatingMenu = false;},MENU_ANIM_TIME);
    }
    
    function showMenu(){
        clearTimeout(menuTimeout);
        clearTimeout(menuAnimTimeout);
        if(!animatingMenu){
            animatingMenu = true;
            $('#location').transition({
                right:0,
                duration: MENU_ANIM_TIME
            });
            $('#cost').transition({
                left:0,
                duration: MENU_ANIM_TIME
            });
        }
        menuAnimTimeout = setTimeout(function(){
            animatingMenu = false;
            menuTimeout = setTimeout(hideMenu,MENU_TIMEOUT);
        },MENU_ANIM_TIME);
    }
    
    function selectLocation(countryID){
      console.log(countryID);
      $('.active').removeClass('active');
      $('#'+countryID).addClass('active');
      $('#cost li[data-country="'+countryID+'"]').addClass('active');
    }
    
    function selectCost(costID){
      console.log(costID);
      $('.selected').removeClass('selected');
      $('#'+costID).addClass('selected');
      selectLocation($('#'+costID).attr('data-country'));
    }
    
    
    $.get('./data/cost.csv',function(data){
        costs = $.csv.toObjects(data);
        $.get('./data/cost-images.csv',function(data){
        costImages = $.csv.toObjects(data);
        costImages.sort(function compare(a,b) {
          var aC = parseInt(a.cost.replace(/,/g, ""));
          var bC = parseInt(b.cost.replace(/,/g, ""));
          if (aC < bC) return -1;
          if (bC > aC) return 1;
          return 0;
        });
        minCost = costs[0].cost;
        maxCost = costs[costs.length-1].cost;
        dataLoaded = true;
        loadComplete();
        $('#cost .min').text('$'+minCost).attr('data-value',minCost.cost.replace(/,/g, ""));
        $('#cost .max').text('$'+maxCost).attr('data-value',maxCost.cost.replace(/,/g, ""));
        $.each(costs,function(i,c){
          var countryID = c.location.trim().toLowerCase().replace(' ','-');
          var costID = 'cost'+i;
          if(!$('#'+countryID).length){
            $('#location ul').append('<li id="'+countryID+'"><a href="#">'+c.location.trim()+'</a></li>').find('a').click(function(){
               selectLocation(countryID);
            });
          }
          var value = parseInt(c.cost.replace(/,/g, ""));
          $('<li id="'+costID+'" data-value="'+value+'" data-country="'+countryID+'"><a href="#">$'+c.cost.trim()+'</a></li>').css({
            top:(Math.round((value-minCost)/(maxCost-minCost)*$(window).height()))+'px';
          }).appendTo('#cost ul').find('a').click(function(){
            selectCost(costID);
          });
          var html = '<li data-cost="'+costID+'"><img src="http://placekitten.com/768/1026" alt="" /><canvas></canvas><div class="info"><h2><span class="name">Matt</span>&#39;s life is worth $'+c.cost+'</h2><br><h3>as '+c.as+' in '+c.location;
          if(c.when) html += ', '+c.when;
          html += '.</h3></div></li>';
          $c = $(html).appendTo($('#content ul'));
          var canvas = $c.find('canvas').get(0);
          var image = new Image();
          var ctx = canvas.getContext('2d');
          image.onload = function() {
            canvas.width = image.width;
            canvas.height = image.height;
            ctx.globalCompositeOperation = 'source-over';
            ctx.drawImage(image, 0, 0);
            ctx.globalCompositeOperation = 'destination-out';
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(parseInt(0.27*canvas.width),0);
            ctx.lineTo(0,canvas.height);
            ctx.closePath();
            ctx.fill();
        };
        image.src = './img/cost/'+costImages[i].filename;
        });
        
        });
    });
    
    function loadComplete(){
        if(friendsLoaded && dataLoaded){
            //ready to go
            
            $.each(costs,function(i,c){
            	if(typeof c.gender === 'undefined' || c.gender.length == 0) c.gender = 'b';
            	for ( var j = 0; j < friends.length; j++){
            		if( typeof friends[j].gender != 'undefined' &&
            		    (c.gender == 'b' || c.gender == friends[j].gender[0]) && 
            		    !friends[j].used ){
            			
            			friends[j].used = true;
            			var content = $("#content li")[i];
            			$(content).find("img").attr("src", friends[j].photo);
            			$(content).find(".name").text(friends[j].name);
            			break;
            		}
            	}
            });
            $('.overlay').hide();
        }
    }
    
    $('.facebook.button').click(function(e){
        $('#start').html('<p>Loading friends...</p>').addClass('loading');
        FB.login(getFriends, {scope: 'basic_info,user_birthday,friends_birthday'});
    });
    $('.message.close').click(function(){
      $('.overlay').hide();
    });
        
        function getFriends() {
            FB.api('/me/friends?fields=id,name,first_name,gender,birthday', function(a) {
                if(a.data) {
                    $.each(a.data,function(i,friend) {
                    
                        FB.api('/'+friend.id+'/picture?width=9999&height=9999',
                        function(b) {
                            if(!b.is_silhouette) {
                                friends[i] = {};
                                friends[i].name = friend.first_name;
                                friends[i].gender = friend.gender;
                                friends[i].photo = b.data.url;
                                friends[i].age = '';
                                friends[i].used = false;
                                if(friend.birthday){
                                    var c = friend.birthday.split('/');
                                    if(c.length == 3){
                                        friends[i].age =  new Date().getFullYear() - parseInt(c[2]);
                                    }
                                }
                            }
                            if(i == a.data.length-1){
                                friendsLoaded = true;
                                loadComplete();
                            }
                        });
                    });
                   
                } else {
                    alert("Error!");
                }
            });
        }

});

};

(function(d, s, id){
 var js, fjs = d.getElementsByTagName(s)[0];
 if (d.getElementById(id)) {return;}
 js = d.createElement(s); js.id = id;
 js.src = "//connect.facebook.net/en_US/all.js";
 fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
    </script>
    <div id="content"><ul></ul></div>
    <div id="interface">
        <div id="cost">
          <ul></ul>
          <div class="label max" data-value="100000">$100,000</div>
          <div class="label min" data-value="48">$48</div>
        </div>
        <div id="location"><ul></ul></div>
        <div id="header">
            <h1><a href="#">The Price of Humanity</a></h1>
        </div>
        <div class="overlay">
          <div id="start" class="message">
            <a class="facebook button" href="#">Log-in with Facebook</a>
            <p>(We won't be storing or sharing your information)</p>
            <p>or <a href="#" class="close">view only our photos</a></p>
          </div>
        </div>
    </div>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49237320-1', 'priceofhumanity.com');
  ga('send', 'pageview');

  </script>
  </body>
  </html>